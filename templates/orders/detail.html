{% extends "base/base.html" %}
{% load static %}

{% block title %}جزئیات سفارش #{{ order.id }} | زیما{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/orders_detail.css' %}">
{% endblock %}

{% block content %}
<!-- Order Detail Section -->
<section class="order-detail-section">
    <div class="order-detail-container">
        <div class="order-detail-card">
            <div class="order-detail-header">
                <div class="header-left">
                    <h1>سفارش #{{ order.id }}</h1>
                    <p>تاریخ ثبت: {{ order.created_at|date:"Y/m/d H:i" }}</p>
                </div>
                <div class="header-right">
                    <span class="order-status-badge status-{{ order.get_status_display_class }}">
                        {{ order.get_status_display }}
                    </span>
                </div>
            </div>

            <div class="order-detail-body">
                <div class="order-items-section">
                    <h2 class="section-title">محصولات سفارش</h2>
                    <div class="order-items-list">
                        {% for item in order.items.all %}
                        <div class="order-item">
                            <div class="item-image">
                                {% with image=item.product_variant.product.get_main_image %}
                                <img src="{% if image %}{{ image.image.url }}{% else %}{% static 'images/zima_theme/product-placeholder.jpg' %}{% endif %}" alt="{{ item.product_variant.product.name }}">
                                {% endwith %}
                            </div>
                            <div class="item-details">
                                <p class="item-name">{{ item.product_variant.product.name }}</p>
                                <p class="item-variant">
                                    {% if item.product_variant.color %}رنگ: {{ item.product_variant.color.name }}{% endif %}
                                    {% if item.product_variant.size %}، سایز: {{ item.product_variant.size.name }}{% endif %}
                                </p>
                                <div class="item-price-qty">
                                    <span class="item-price">{{ item.get_total_price|floatformat:0 }} تومان</span>
                                    <span class="item-quantity">تعداد: {{ item.quantity }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="order-summary-section">
                    <h2 class="section-title">خلاصه سفارش</h2>
                    <div class="summary-items">
                        <div class="summary-item">
                            <span>مبلغ کل محصولات:</span>
                            <span>{{ order.get_total_items_price|floatformat:0 }} تومان</span>
                        </div>
                        <div class="summary-item">
                            <span>هزینه ارسال:</span>
                            <span>{{ order.shipping_cost|floatformat:0 }} تومان</span>
                        </div>
                        {% if order.discount_amount %}
                        <div class="summary-item">
                            <span>تخفیف:</span>
                            <span>- {{ order.discount_amount|floatformat:0 }} تومان</span>
                        </div>
                        {% endif %}
                        <div class="summary-total">
                            <span>مبلغ نهایی:</span>
                            <span>{{ order.final_amount|floatformat:0 }} تومان</span>
                        </div>
                    </div>

                    <div class="shipping-address-section">
                        <h2 class="section-title">آدرس ارسال</h2>
                        <div class="address-card">
                            <p><strong>گیرنده:</strong> {{ order.address.full_name }}</p>
                            <p><strong>تلفن:</strong> {{ order.address.phone_number }}</p>
                            <p><strong>استان:</strong> {{ order.address.province }}</p>
                            <p><strong>شهر:</strong> {{ order.address.city }}</p>
                            <p><strong>آدرس کامل:</strong> {{ order.address.address_line1 }}</p>
                            <p><strong>کد پستی:</strong> {{ order.address.postal_code }}</p>
                        </div>
                    </div>

                    <div class="payment-method-section">
                        <h2 class="section-title">روش پرداخت</h2>
                        <div class="payment-card">
                            <p><strong>روش:</strong> {{ order.get_payment_method_display }}</p>
                            {% if order.payment_status %}
                            <p><strong>وضعیت پرداخت:</strong> {{ order.get_payment_status_display }}</p>
                            {% endif %}
                            {% if order.payment_ref_id %}
                            <p><strong>کد رهگیری پرداخت:</strong> {{ order.payment_ref_id }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="order-actions-bottom">
                <a href="{% url 'orders:list' %}" class="btn-back">
                    <i class="fas fa-arrow-right"></i>
                    بازگشت به لیست سفارشات
                </a>
                {% if order.status == 'pending' %}
                <button class="btn-cancel" onclick="confirmCancelOrder('{{ order.id }}')">
                    <i class="fas fa-times-circle"></i>
                    لغو سفارش
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function confirmCancelOrder(orderId) {
        if (confirm("آیا از لغو این سفارش مطمئن هستید؟ این عمل قابل بازگشت نیست.")) {
            fetch(`{% url 'orders:cancel_order' order.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'order_id': orderId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'check-circle');
                    setTimeout(() => window.location.reload(), 2000); // رفرش صفحه برای به‌روزرسانی وضعیت
                } else {
                    showToast(data.message, 'exclamation-triangle');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('خطا در لغو سفارش', 'exclamation-triangle');
            });
        }
    }

    // یک تابع showToast ساده برای نمایش پیام‌ها (اگر قبلاً در base.html تعریف نشده باشد)
    function showToast(message, icon) {
        // Remove existing toasts
        document.querySelectorAll('.toast').forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-${icon}"></i>
            </div>
            <div class="toast-message">${message}</div>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}