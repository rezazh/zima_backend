{% extends "base/base.html" %}
{% load static %}

{% block title %}{{ product.name }} | زیما{% endblock %}

{% block meta_description %}{{ product.description|truncatewords:20 }}{% endblock %}

{% block content %}
<!-- Product Breadcrumb -->
<section class="product-breadcrumb">
    <div class="container">
        <nav class="breadcrumb-nav">
            <a href="{% url 'pages:home' %}">خانه</a>
            <span>/</span>
            <a href="{% url 'products:product_list' %}">محصولات</a>
            {% if product.category %}
                <span>/</span>
                {% if product.category.parent %}
                    <a href="{% url 'products:category_list' product.category.parent.slug %}">{{ product.category.parent.name }}</a>
                    <span>/</span>
                {% endif %}
                <a href="{% url 'products:category_list' product.category.slug %}">{{ product.category.name }}</a>
            {% endif %}
            <span>/</span>
            <span class="current">{{ product.name|truncatewords:3 }}</span>
        </nav>
    </div>
</section>

<!-- Product Detail Section -->
<section class="product-detail-section">
    <div class="container">
        <div class="product-detail-wrapper">
            <!-- Product Images -->
            <div class="product-images">
                <div class="main-image-container">
                    {% with main_image=product.get_main_image %}
                        <img src="{% if main_image %}{{ main_image.image.url }}{% else %}{% static 'images/zima_theme/product-placeholder.jpg' %}{% endif %}"
                             alt="{{ product.name }}"
                             class="main-product-image"
                             id="mainProductImage">
                    {% endwith %}

                    <!-- Product Badges -->
                    <div class="product-badges-detail">
                        {% if product.is_new %}
                            <span class="product-badge new">جدید</span>
                        {% endif %}
                        {% if product.has_discount %}
                            <span class="product-badge sale">{{ product.discount_percent }}% تخفیف</span>
                        {% endif %}
                        {% if product.is_featured %}
                            <span class="product-badge featured">ویژه</span>
                        {% endif %}
                    </div>

                    <!-- Zoom Button -->
                    <button class="zoom-btn" onclick="zoomImage()">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>

                <!-- Thumbnail Images -->
                {% if product.images.count > 1 %}
                    <div class="thumbnail-container">
                        {% for image in product.images.all %}
                            <div class="thumbnail-item {% if forloop.first %}active{% endif %}"
                                 onclick="changeMainImage(this, '{{ image.image.url }}')">
                                <img src="{{ image.image.url }}" alt="{{ product.name }}">
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- Product Info -->
            <div class="product-info-detail">
                <!-- Product Header -->
                <div class="product-header">
                    <div class="product-brand-detail">{{ product.brand }}</div>
                    <h1 class="product-title-detail">{{ product.name }}</h1>

                    <!-- Product Rating -->
                    <div class="product-rating-detail">
                        <div class="stars-large">
                            {% with rating=product.get_average_rating|default:0 %}
                                {% for i in "12345" %}
                                    <i class="fa{% if forloop.counter <= rating %}s{% else %}r{% endif %} fa-star star"></i>
                                {% endfor %}
                            {% endwith %}
                        </div>
                        <span class="rating-number">({{ product.get_average_rating|default:0|floatformat:1 }})</span>
                        <span class="reviews-count">{{ product.get_rating_count|default:0 }} نظر</span>
                        <a href="#reviews" class="add-review-link">نظر شما</a>
                    </div>
                </div>

                <!-- Price Section -->
                <div class="price-section">
                    <span class="current-price">{{ product.get_display_price|floatformat:0 }} تومان</span>
                    {% if product.has_discount %}
                        <span class="original-price">{{ product.price|floatformat:0 }} تومان</span>
                        <span class="discount-badge">{{ product.discount_percent }}% تخفیف</span>
                    {% endif %}
                </div>

                <!-- Stock Status -->
                <div class="stock-status">
                    {% if total_stock > 0 %}
                        <span class="in-stock">
                            <i class="fas fa-check-circle"></i>
                            موجود در انبار (<span id="current-stock">{{ total_stock }}</span> عدد)
                        </span>
                    {% else %}
                        <span class="out-of-stock">
                            <i class="fas fa-times-circle"></i>
                            ناموجود
                        </span>
                    {% endif %}
                </div>

                <!-- Product Description -->
                <div class="product-description-short">
                    <p>{{ product.description|default:"توضیحاتی برای این محصول ارائه نشده است." }}</p>
                </div>

                <!-- Product Options -->
                <div class="product-options">
                    <!-- Color Selection -->
                    {% if available_colors %}
                        <div class="option-group">
                            <label class="option-label">
                                رنگ: <span class="selected-color-name">انتخاب کنید</span>
                            </label>
                            <div class="color-options-detail">
                                {% for color in available_colors %}
                                    <label class="color-option-detail"
                                           data-color-id="{{ color.id }}"
                                           data-color-name="{{ color.name }}"
                                           style="background: {{ color.hex_code }};">
                                        <input type="radio" name="color" value="{{ color.id }}">
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Size Selection -->
                    {% if available_sizes %}
                        <div class="option-group">
                            <label class="option-label">سایز:</label>
                            <div class="size-options-detail">
                                {% for size in available_sizes %}
                                    <label class="size-option-detail" data-size-id="{{ size.id }}">
                                        <input type="radio" name="size" value="{{ size.id }}">
                                        <span>{{ size.name }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Quantity Selection -->
                    <div class="option-group">
                        <label class="option-label">تعداد:</label>
                        <div class="quantity-selector-detail">
                            <button type="button" class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                            <input type="number"
                                   id="quantity"
                                   class="quantity-input-detail"
                                   value="1"
                                   min="1"
                                   max="{{ total_stock }}"
                                   readonly>
                            <button type="button" class="quantity-btn" onclick="changeQuantity(1)">+</button>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="product-actions-detail">
                    {% if total_stock > 0 %}
                        <button class="btn-add-to-cart-detail" onclick="addToCartDetail('{{ product.id }}')">
                            <i class="fas fa-shopping-cart"></i>
                            افزودن به سبد خرید
                        </button>
                    {% else %}
                        <button class="btn-add-to-cart-detail disabled" disabled>
                            <i class="fas fa-times"></i>
                            ناموجود
                        </button>
                    {% endif %}

                    <button class="btn-wishlist-detail {% if product.is_favorited %}active{% endif %}"
                            onclick="toggleWishlist(this, '{{ product.id }}')">
                        <i class="fa{% if product.is_favorited %}s{% else %}r{% endif %} fa-heart"></i>
                        علاقه‌مندی‌ها
                    </button>
                </div>

                <!-- Social Share -->
                <div class="social-share">
                    <span class="share-label">اشتراک‌گذاری:</span>
                    <div class="share-buttons">
                        <a href="#" class="share-btn telegram" onclick="shareProduct('telegram')">
                            <i class="fab fa-telegram-plane"></i>
                        </a>
                        <a href="#" class="share-btn whatsapp" onclick="shareProduct('whatsapp')">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <a href="#" class="share-btn copy" onclick="shareProduct('copy')">
                            <i class="fas fa-copy"></i>
                        </a>
                    </div>
                </div>

                <!-- Product Features -->
                <div class="product-features">
                    <div class="feature-item">
                        <i class="fas fa-truck"></i>
                        <span>ارسال رایگان برای خریدهای بالای ۵۰۰ هزار تومان</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-undo"></i>
                        <span>۷ روز ضمانت بازگشت کالا</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>ضمانت اصالت کالا</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-headset"></i>
                        <span>پشتیبانی ۲۴ ساعته</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Product Tabs Section -->
<section class="product-tabs-section">
    <div class="container">
        <div class="tabs-wrapper">
            <!-- Tab Headers -->
            <div class="tab-headers">
                <button class="tab-header active" data-tab="description">توضیحات</button>
                <button class="tab-header" data-tab="specifications">مشخصات</button>
                <button class="tab-header" data-tab="reviews">نظرات ({{ product.get_rating_count|default:0 }})</button>
                <button class="tab-header" data-tab="qa">پرسش و پاسخ</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-contents">
                <!-- Description Tab -->
                <div class="tab-content active" id="description">
                    <div class="description-content">
                        <p>{{ product.description|default:"توضیحات کاملی برای این محصول ارائه نشده است." }}</p>
                    </div>
                </div>

                <!-- Specifications Tab -->
                <div class="tab-content" id="specifications">
                    <table class="specs-table">
                        <tr>
                            <td>برند</td>
                            <td>{{ product.brand }}</td>
                        </tr>
                        {% if product.category %}
                        <tr>
                            <td>دسته‌بندی</td>
                            <td>{{ product.category.name }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td>کد محصول</td>
                            <td>{{ product.id }}</td>
                        </tr>
                        <tr>
                            <td>وزن</td>
                            <td>{{ product.weight|default:"مشخص نشده" }}</td>
                        </tr>
                        <tr>
                            <td>رنگ‌های موجود</td>
                            <td>
                                {% for color in available_colors %}
                                    {{ color.name }}{% if not forloop.last %}، {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                        <tr>
                            <td>سایزهای موجود</td>
                            <td>
                                {% for size in available_sizes %}
                                    {{ size.name }}{% if not forloop.last %}، {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-content" id="reviews">
                    <div class="reviews-content">
                        <!-- Reviews Summary -->
                        <div class="reviews-summary">
                            <div class="rating-overview">
                                <div class="average-rating">
                                    <span class="rating-number-large">{{ product.get_average_rating|default:0|floatformat:1 }}</span>
                                    <div class="stars-large">
                                        {% with rating=product.get_average_rating|default:0 %}
                                            {% for i in "12345" %}
                                                <i class="fa{% if forloop.counter <= rating %}s{% else %}r{% endif %} fa-star star"></i>
                                            {% endfor %}
                                        {% endwith %}
                                    </div>
                                    <span class="total-reviews">{{ product.get_rating_count|default:0 }} نظر</span>
                                </div>
                                <div class="rating-breakdown">
                                    {% for i in "54321" %}
                                        <div class="rating-bar">
                                            <span>{{ i }} ستاره</span>
                                            <div class="bar">
                                                <div class="fill" style="width: 0%"></div>
                                            </div>
                                            <span>0</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Add Review Section -->
                        <div class="add-review-section">
                            <h3>نظر شما</h3>
                            {% if user.is_authenticated %}
                                {% if has_purchased %}
                                    <form class="review-form" id="reviewForm">
                                        {% csrf_token %}
                                        <div class="rating-input">
                                            <label>امتیاز شما:</label>
                                            <div class="star-rating-input">
                                                {% for i in "54321" %}
                                                    <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}">
                                                    <label for="star{{ i }}">★</label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>متن نظر:</label>
                                            <textarea name="comment" rows="4" placeholder="نظر خود را بنویسید..."></textarea>
                                        </div>
                                        <button type="submit" class="btn-submit-review">ثبت نظر</button>
                                    </form>
                                {% else %}
                                    <div class="review-restriction">
                                        <p>فقط کاربرانی که این محصول را خریداری کرده‌اند می‌توانند نظر ثبت کنند.</p>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="login-required">
                                    <p>برای ثبت نظر ابتدا <a href="{% url 'users:login' %}">وارد حساب کاربری</a> خود شوید.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Reviews List -->
                        <div class="reviews-list">
                            {% for review in product.reviews.all %}
                                <div class="review-item">
                                    <div class="review-header">
                                        <div class="reviewer-info">
                                            <div class="reviewer-avatar">
                                                {{ review.user.first_name.0|default:review.user.username.0|upper }}
                                            </div>
                                            <div class="reviewer-details">
                                                <div class="reviewer-name">{{ review.user.get_full_name|default:review.user.username }}</div>
                                                <div class="review-date">{{ review.created_at|date:"Y/m/d" }}</div>
                                            </div>
                                        </div>
                                        <div class="review-rating">
                                            {% for i in "12345" %}
                                                <i class="fa{% if forloop.counter <= review.rating %}s{% else %}r{% endif %} fa-star star"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="review-content">
                                        <p>{{ review.comment }}</p>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="no-reviews">
                                    <i class="fas fa-comments"></i>
                                    <p>هنوز نظری ثبت نشده است. اولین نفری باشید که نظر می‌دهد!</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Q&A Tab -->
                <div class="tab-content" id="qa">
                    <div class="qa-content">
                        <!-- Add Question Section -->
                        <div class="add-question-section">
                            <h3>سوال شما</h3>
                            {% if user.is_authenticated %}
                                <form class="question-form">
                                    <textarea placeholder="سوال خود را بپرسید..."></textarea>
                                    <button type="submit" class="btn-submit-question">ثبت سوال</button>
                                </form>
                            {% else %}
                                <div class="login-required">
                                    <p>برای ثبت سوال ابتدا <a href="{% url 'users:login' %}">وارد حساب کاربری</a> خود شوید.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Questions List -->
                        <div class="questions-list">
                            <!-- Sample Q&A - Replace with actual data -->
                            <div class="question-item">
                                <div class="question">
                                    <div class="question-header">
                                        <span class="questioner">کاربر نمونه</span>
                                        <span class="question-date">1403/05/15</span>
                                    </div>
                                    <p>این محصول چه مدت گارانتی دارد؟</p>
                                </div>
                                <div class="answer">
                                    <div class="answer-header">
                                        <span class="answerer">پشتیبانی زیما</span>
                                        <span class="answer-date">1403/05/16</span>
                                    </div>
                                    <p>این محصول دارای ۱۸ ماه گارانتی شرکتی می‌باشد.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products -->
{% if related_products %}
<section class="related-products-section">
    <div class="container">
        <div class="section-header text-center">
            <h2 class="section-title">محصولات مرتبط</h2>
            <p class="section-description">محصولات مشابهی که ممکن است علاقه‌مند باشید</p>
        </div>
        <div class="related-products-grid">
            {% for related_product in related_products %}
                <div class="product-card fade-in">
                    <div class="product-image-container">
                        <div class="product-badges">
                            {% if related_product.is_new %}
                                <span class="product-badge new">جدید</span>
                            {% endif %}
                            {% if related_product.has_discount %}
                                <span class="product-badge sale">{{ related_product.discount_percent }}% تخفیف</span>
                            {% endif %}
                        </div>
                        <div class="product-actions">
                            <button class="action-btn" onclick="toggleWishlist(this, '{{ related_product.id }}')">
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="action-btn" onclick="openQuickView('{{ related_product.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <a href="{% url 'products:product_detail' related_product.id %}">
                            {% with image=related_product.get_main_image %}
                                <img src="{% if image %}{{ image.image.url }}{% else %}{% static 'images/zima_theme/product-placeholder.jpg' %}{% endif %}"
                                     alt="{{ related_product.name }}" class="product-image">
                            {% endwith %}
                        </a>
                    </div>
                    <div class="product-info">
                        <div class="product-brand">{{ related_product.brand }}</div>
                        <a href="{% url 'products:product_detail' related_product.id %}" class="text-decoration-none">
                            <h3 class="product-name">{{ related_product.name }}</h3>
                        </a>
                        <div class="product-rating">
                            <div class="stars">
                                {% with rating=related_product.get_average_rating|default:0 %}
                                    {% for i in "12345" %}
                                        <i class="fa{% if forloop.counter <= rating %}s{% else %}r{% endif %} fa-star star"></i>
                                    {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="rating-text">({{ related_product.get_rating_count|default:0 }})</span>
                        </div>
                        <div class="product-price">
                            <span class="price-current">{{ related_product.get_display_price|floatformat:0 }} تومان</span>
                            {% if related_product.has_discount %}
                                <span class="price-original">{{ related_product.price|floatformat:0 }} تومان</span>
                            {% endif %}
                        </div>
                        <button class="product-add-cart" onclick="addToCart('{{ related_product.id }}')">
                            <i class="fas fa-shopping-cart"></i>
                            افزودن به سبد خرید
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Image Zoom Modal -->
<div class="image-zoom-modal" id="imageZoomModal">
    <div class="zoom-modal-content">
        <button class="zoom-close" onclick="closeImageZoom()">
            <i class="fas fa-times"></i>
        </button>
        <div class="zoom-container">
            <img src="" alt="" id="zoomedImage">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// داده‌های موجودی از سرور
const inventoryMapping = {{ inventory_mapping|safe }};
let selectedColor = null;
let selectedSize = null;

document.addEventListener('DOMContentLoaded', function() {
    // Change main image when thumbnail is clicked
    window.changeMainImage = function(thumbnail, imageSrc) {
        const mainImage = document.getElementById('mainProductImage');
        mainImage.src = imageSrc;

        // Update active thumbnail
        document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
        thumbnail.classList.add('active');
    };

    // Quantity change functionality
    window.changeQuantity = function(change) {
        const quantityInput = document.getElementById('quantity');
        const currentValue = parseInt(quantityInput.value);
        const maxStock = parseInt(quantityInput.max);
        const newValue = currentValue + change;

        if (newValue >= 1 && newValue <= maxStock) {
            quantityInput.value = newValue;
        }
    };

    // Color selection with inventory update
    document.querySelectorAll('.color-option-detail').forEach(option => {
        option.addEventListener('click', function() {
            if (this.style.pointerEvents === 'none') return;

            document.querySelectorAll('.color-option-detail').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');

            selectedColor = this.dataset.colorId;
            const colorName = this.dataset.colorName;
            document.querySelector('.selected-color-name').textContent = colorName;

            // Reset size selection
            selectedSize = null;
            document.querySelectorAll('.size-option-detail').forEach(opt => {
                opt.classList.remove('active');
                opt.style.opacity = '0.5';
                opt.style.pointerEvents = 'none';
            });

            // Enable available sizes for selected color
            updateAvailableOptions();
        });
    });

    // Size selection with inventory update
    document.querySelectorAll('.size-option-detail').forEach(option => {
        option.addEventListener('click', function() {
            if (this.style.pointerEvents === 'none') return;

            document.querySelectorAll('.size-option-detail').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');

            selectedSize = this.dataset.sizeId;

            // Reset color selection if needed
            if (!selectedColor) {
                document.querySelectorAll('.color-option-detail').forEach(opt => {
                    opt.classList.remove('active');
                    opt.style.opacity = '0.5';
                    opt.style.pointerEvents = 'none';
                });
            }

            // Enable available colors for selected size
            updateAvailableOptions();
        });
    });

    // Function to update available options based on selection
    function updateAvailableOptions() {
        if (selectedColor && !selectedSize) {
            // Color selected, update available sizes
            const availableSizes = inventoryMapping[selectedColor] || {};

            document.querySelectorAll('.size-option-detail').forEach(sizeOption => {
                const sizeId = sizeOption.dataset.sizeId;
                if (availableSizes[sizeId]) {
                    sizeOption.style.opacity = '1';
                    sizeOption.style.pointerEvents = 'auto';
                } else {
                    sizeOption.style.opacity = '0.3';
                    sizeOption.style.pointerEvents = 'none';
                }
            });
        } else if (selectedSize && !selectedColor) {
            // Size selected, update available colors
            document.querySelectorAll('.color-option-detail').forEach(colorOption => {
                const colorId = colorOption.dataset.colorId;
                const colorInventory = inventoryMapping[colorId] || {};

                if (colorInventory[selectedSize]) {
                    colorOption.style.opacity = '1';
                    colorOption.style.pointerEvents = 'auto';
                } else {
                    colorOption.style.opacity = '0.3';
                    colorOption.style.pointerEvents = 'none';
                }
            });
        }

        // Update stock quantity
        updateStockQuantity();
    }

    // Function to update stock quantity display
    function updateStockQuantity() {
        let totalStock = 0;

        if (selectedColor && selectedSize) {
            const inventory = inventoryMapping[selectedColor]?.[selectedSize];
            totalStock = inventory ? inventory.quantity : 0;
        } else if (selectedColor) {
            const colorInventory = inventoryMapping[selectedColor] || {};
            totalStock = Object.values(colorInventory).reduce((sum, inv) => sum + inv.quantity, 0);
        } else if (selectedSize) {
            Object.values(inventoryMapping).forEach(colorInv => {
                if (colorInv[selectedSize]) {
                    totalStock += colorInv[selectedSize].quantity;
                }
            });
        } else {
            // No selection, show total stock
            Object.values(inventoryMapping).forEach(colorInv => {
                Object.values(colorInv).forEach(inv => {
                    totalStock += inv.quantity;
                });
            });
        }

        document.getElementById('current-stock').textContent = totalStock;
        document.getElementById('quantity').max = totalStock;

        // Reset quantity if it exceeds available stock
        const currentQty = parseInt(document.getElementById('quantity').value);
        if (currentQty > totalStock) {
            document.getElementById('quantity').value = Math.max(1, totalStock);
        }
    }

    // Tab functionality
    document.querySelectorAll('.tab-header').forEach(header => {
        header.addEventListener('click', function() {
            const tabId = this.dataset.tab;

            // Remove active class from all headers and contents
            document.querySelectorAll('.tab-header').forEach(h => h.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Add active class to clicked header and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Star rating functionality for reviews
    document.querySelectorAll('.star-rating-input input').forEach(input => {
        input.addEventListener('change', function() {
            const rating = this.value;
            const labels = this.closest('.star-rating-input').querySelectorAll('label');

            labels.forEach((label, index) => {
                if (labels.length - index <= rating) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
        });
    });

    // Review form submission
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const rating = formData.get('rating');
            const comment = formData.get('comment');

            if (!rating) {
                showToast('لطفاً امتیاز خود را انتخاب کنید', 'exclamation-triangle');
                return;
            }

            if (!comment.trim()) {
                showToast('لطفاً متن نظر خود را وارد کنید', 'exclamation-triangle');
                return;
            }

            // Submit review via AJAX
            fetch(`{% url 'products:add_review' product.id %}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'check');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast(data.message, 'exclamation-triangle');
                    if (data.redirect) {
                        setTimeout(() => window.location.href = data.redirect, 2000);
                    }
                }
            })
            .catch(error => {
                showToast('خطا در ثبت نظر', 'exclamation-triangle');
            });
        });
    }

    // Image zoom functionality
    window.zoomImage = function() {
        const mainImage = document.getElementById('mainProductImage');
        const zoomModal = document.getElementById('imageZoomModal');
        const zoomedImage = document.getElementById('zoomedImage');

        zoomedImage.src = mainImage.src;
        zoomModal.classList.add('active');

        // Add zoom and pan functionality
        let scale = 1;
        let panning = false;
        let pointX = 0;
        let pointY = 0;
        let start = { x: 0, y: 0 };

        function setTransform() {
            zoomedImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }

        zoomedImage.onmousedown = function(e) {
            e.preventDefault();
            start = { x: e.clientX - pointX, y: e.clientY - pointY };
            panning = true;
        };

        zoomedImage.onmousemove = function(e) {
            e.preventDefault();
            if (!panning) return;
            pointX = e.clientX - start.x;
            pointY = e.clientY - start.y;
            setTransform();
        };

        zoomedImage.onmouseup = function(e) {
            panning = false;
        };

        zoomedImage.onwheel = function(e) {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = e.wheelDelta ? e.wheelDelta : -e.deltaY;

            if (delta > 0) {
                scale *= 1.2;
            } else {
                scale /= 1.2;
            }

            scale = Math.min(Math.max(0.5, scale), 4);

            pointX = e.clientX - xs * scale;
            pointY = e.clientY - ys * scale;

            setTransform();
        };
    };

    window.closeImageZoom = function() {
        document.getElementById('imageZoomModal').classList.remove('active');
    };

    // Add to cart functionality
    window.addToCartDetail = function(productId) {
        const quantity = document.getElementById('quantity').value;

        const requestData = {
            product_id: productId,
            quantity: parseInt(quantity),
            color_id: selectedColor,
            size_id: selectedSize
        };

        fetch('{% url "products:add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'shopping-cart');
            } else {
                showToast(data.message, 'exclamation-triangle');
                if (data.redirect) {
                    setTimeout(() => window.location.href = data.redirect, 2000);
                }
            }
        })
        .catch(error => {
            showToast('خطا در افزودن به سبد خرید', 'exclamation-triangle');
        });
    };

    // Share product functionality
    window.shareProduct = function(platform) {
        const url = window.location.href;
        const title = document.querySelector('.product-title-detail').textContent;

        switch(platform) {
            case 'telegram':
                window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`);
                break;
            case 'whatsapp':
                window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`);
                break;
            case 'copy':
                navigator.clipboard.writeText(url);
                showToast('لینک کپی شد!', 'copy');
                break;
        }
    };
});

// Toast notification function
function showToast(message, icon) {
    // Remove existing toasts
    document.querySelectorAll('.toast').forEach(toast => toast.remove());

    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'toast show';
    toast.innerHTML = `
        <div class="toast-icon">
            <i class="fas fa-${icon}"></i>
        </div>
        <div class="toast-message">${message}</div>
    `;

    document.body.appendChild(toast);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}