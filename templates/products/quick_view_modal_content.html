{# templates/products/quick_view_modal_content.html #}
{% load static %}

<div class="modal-content-qv-inner">
    <div class="modal-images-qv">
        {% with main_image=product.get_main_image %}
        <img src="{% if main_image %}{{ main_image.image.url }}{% else %}{% static 'images/zima_theme/product-placeholder.jpg' %}{% endif %}"
             alt="{{ product.name }}"
             class="main-image-qv"
             id="mainImageQv">
        {% endwith %}

        {% if product.images.count > 1 %}
        <div class="thumbnail-list-qv">
            {% for image in product.images.all %}
            <img src="{{ image.image.url }}"
                 alt="Thumb {{ forloop.counter }}"
                 class="thumbnail-qv {% if forloop.first %}active{% endif %}"
                 onclick="changeImageQv(this)">
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="modal-details-qv">
        <div class="product-header-qv">
            <div class="modal-brand-qv">{{ product.brand|default:"برند نامشخص" }}</div>
            <h2 class="modal-title-qv">{{ product.name }}</h2>
        </div>

        <div class="price-section-qv">
            <span class="current-price-qv">{{ product.get_formatted_display_price }} تومان</span>
            {% if product.has_discount %}
                <span class="original-price-qv">{{ product.get_formatted_price }} تومان</span>
                <span class="discount-badge-qv">{{ product.discount_percent }}% تخفیف</span>
            {% endif %}
        </div>

        <p class="modal-description-qv">
            {{ product.description|truncatewords:25|default:"توضیحات کوتاه برای این محصول موجود نیست." }}
        </p>

        <div class="modal-options-qv">
            <div class="option-group-qv" id="colorOptionGroupQv" style="display: none;">
                <label class="option-label-qv">رنگ: <span id="selectedColorNameQv">انتخاب کنید</span></label>
                <div class="color-options-qv" id="modalColorOptionsQv"></div>
            </div>

            <div class="option-group-qv" id="sizeOptionGroupQv" style="display: none;">
                <label class="option-label-qv">سایز: <span id="selectedSizeNameQv">انتخاب کنید</span></label>
                <div class="size-options-qv" id="modalSizeOptionsQv"></div>
            </div>

            <div class="option-group-qv">
                <label class="option-label-qv">تعداد:</label>
                <div class="quantity-selector-qv">
                    <button class="quantity-btn-qv" type="button" onclick="decreaseQuantityQv()">-</button>
                    <input type="number" class="quantity-input-qv" value="1" min="1" max="{{ total_stock }}" id="quantityInputQv" readonly>
                    <button class="quantity-btn-qv" type="button" onclick="increaseQuantityQv()">+</button>
                </div>
            </div>
        </div>

        <div class="modal-actions-qv">
            <button class="btn-add-to-cart-qv" onclick="window.addToCartFromModal('{{ product.id }}')" id="addToCartBtnQv">
                <i class="fas fa-shopping-bag"></i> افزودن به سبد خرید
            </button>
            <button class="btn-wishlist-qv" onclick="toggleWishlist(this, '{{ product.id }}')">
                <i class="far fa-heart"></i>
            </button>
        </div>
    </div>
</div>

<script type="application/json" id="quickViewProductJsonData">{
    "id": {{ product.id }},
    "stock": {{ total_stock }},
    "hasDiscount": {% if product.has_discount %}true{% else %}false{% endif %},
    "discountPercent": {{ product.discount_percent|default:0 }},
    "inventoryMapping": {{ inventory_mapping|safe }},
    "availableColors": [{% for color in available_colors %}{"id": {{ color.id }}, "name": "{{ color.name|escapejs }}", "hex_code": "{{ color.hex_code|default:'#CCCCCC' }}"}{% if not forloop.last %},{% endif %}{% endfor %}],
    "availableSizes": [{% for size in available_sizes %}{"id": {{ size.id }}, "name": "{{ size.name|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]
}</script>

<script>
// اجرای فوری
document.addEventListener('DOMContentLoaded', function() {
    const jsonScript = document.getElementById('quickViewProductJsonData');
    if (jsonScript) {
        try {
            const productData = JSON.parse(jsonScript.textContent);
            console.log('🚀 Quick View data loaded, calling init...');

            if (typeof window.initQuickViewModalContent === 'function') {
                window.initQuickViewModalContent(productData);
            } else {
                console.error('❌ initQuickViewModalContent not found');
            }
        } catch (error) {
            console.error('❌ JSON parse error:', error);
        }
    }
});
</script>