{% extends "base/base.html" %}
{% load static %}
{% load product_filters %}

{% block title %}{{ page_title }} | زیما{% endblock %}
{% block body_class %}animated-bg-page{% endblock %} {# ✅ این خط اضافه شد #}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/pages/product_list.css' %}">
{% endblock %}
{% block content %}
<!-- Products Hero -->
<section class="products-hero">
    <div class="hero-content">
        <h1 class="hero-title">{{ page_title }}</h1>
        <p class="hero-subtitle">زیبایی، راحتی و اعتماد به نفس در یک مجموعه</p>
        <nav class="breadcrumb">
            <a href="{% url 'pages:home' %}">خانه</a>
            <span>/</span>
            {% if category %}
                {% if category.parent %}
                    <a href="{% url 'products:category_list' category.parent.slug %}">{{ category.parent.name }}</a>
                    <span>/</span>
                {% endif %}
                <span>{{ category.name }}</span>
            {% else %}
                <span>محصولات</span>
            {% endif %}
        </nav>
    </div>
</section>

<!-- Main Products Section -->
<div class="products-main">
    <!-- Sidebar Filters -->
    <aside class="sidebar" id="sidebar">
        <form method="get" id="filterForm">
            <!-- Search Filter -->
            <div class="filter-section">
                <div class="search-box">
                    <input type="text" name="q" class="search-input" placeholder="جستجو در محصولات..." value="{{ current_filters.q|default:'' }}">
                    <button class="search-btn" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Category Filter -->
            {% if all_categories %}
            <div class="filter-section">
                <div class="filter-header">
                    <h3 class="filter-title">دسته‌بندی</h3>
                    <i class="fas fa-chevron-down filter-toggle"></i>
                </div>
                <div class="filter-content">
                    <div class="filter-content-inner">
                        <ul class="category-list">
                            {% for cat in all_categories %}
                            <li class="category-item">
                               <label class="category-label">
                                    <input type="checkbox" name="categories" value="{{ cat.id }}" class="category-checkbox"
                                           {% if cat.id|stringformat:'s' in current_filters.categories %}checked{% endif %}>
                                    <span class="category-name">{{ cat.name }}</span>
                                    <span class="category-count">({{ cat.product_count }})</span>
                               </label>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Size Filter -->
            {% if all_sizes %}
            <div class="filter-section">
                <div class="filter-header">
                    <h3 class="filter-title">سایز</h3>
                    <i class="fas fa-chevron-down filter-toggle"></i>
                </div>
                <div class="filter-content">
                    <div class="filter-content-inner">
                        <div class="size-grid">
                            {% for size in all_sizes %}
                            <label class="size-btn {% if size.id|stringformat:'s' in current_filters.sizes %}active{% endif %}">
                                <input type="checkbox" name="sizes" value="{{ size.id }}" style="display: none;"
                                       {% if size.id|stringformat:"s" in current_filters.sizes %}checked{% endif %}>
                                {{ size.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Color Filter -->
            {% if all_colors %}
            <div class="filter-section">
                <div class="filter-header">
                    <h3 class="filter-title">رنگ</h3>
                    <i class="fas fa-chevron-down filter-toggle"></i>
                </div>
                <div class="filter-content">
                    <div class="filter-content-inner">
                        <div class="color-grid">
                            {% for color in all_colors %}
                            <label class="color-option {% if color.id|stringformat:'s' in current_filters.colors %}active{% endif %}"
                                   style="background: {{ color.hex_code }}; {% if color.hex_code == '#FFFFFF' %}border: 2px solid #ddd;{% endif %}"
                                   title="{{ color.name }}">
                                <input type="checkbox" name="colors" value="{{ color.id }}" style="display: none;"
                                       {% if color.id|stringformat:"s" in current_filters.colors %}checked{% endif %}>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Price Range Filter -->
            {% if price_range.min_price is not None %}
            <div class="filter-section">
                <div class="filter-header">
                    <h3 class="filter-title">محدوده قیمت</h3>
                    <i class="fas fa-chevron-down filter-toggle"></i>
                </div>
                <div class="filter-content">
                    <div class="filter-content-inner">
                        <div class="price-inputs">
                            <input type="number" name="min_price" class="price-input" placeholder="از" value="{{ current_filters.min_price|default:'' }}">
                            <span>تا</span>
                            <input type="number" name="max_price" class="price-input" placeholder="تا" value="{{ current_filters.max_price|default:'' }}">
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Brand Filter -->
            {% if all_brands %}
            <div class="filter-section">
                <div class="filter-header">
                    <h3 class="filter-title">برند</h3>
                    <i class="fas fa-chevron-down filter-toggle"></i>
                </div>
                <div class="filter-content">
                    <div class="filter-content-inner">
                        <div class="size-grid"> {# از استایل دکمه‌های سایز استفاده می‌کنیم #}
                            {% for brand_name in all_brands %}
                            <label class="size-btn brand-label {% if brand_name in current_filters.brand %}active{% endif %}">
                                <input type="checkbox" name="brand" value="{{ brand_name }}" style="display: none;"
                                       {% if brand_name in current_filters.brand %}checked{% endif %}>
                                {{ brand_name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button type="submit" class="btn-apply">اعمال فیلتر</button>
                <a href="{{ request.path }}" class="btn-reset">پاک کردن</a>
            </div>
        </form>
    </aside>

    <!-- Products Content -->
    <div class="products-content">
        <!-- Products Header -->
        <div class="products-header">
            <div class="results-count">
                <strong>{{ results_count }}</strong> محصول یافت شد
            </div>
            <div class="header-controls">
                <form method="get" id="sortForm" style="display: inline-block;">
                    {% for key, value in request.GET.items %}
                        {% if key != 'sort' %}
                            {% if value|is_list %} {# از فیلتر کاستوم استفاده شد #}
                                {% for item in value %}
                                    <input type="hidden" name="{{ key }}" value="{{ item }}">
                                {% endfor %}
                            {% else %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    <select name="sort" class="sort-dropdown" onchange="this.form.submit()">
                        <option value="newest" {% if current_filters.sort == 'newest' %}selected{% endif %}>جدیدترین</option>
                        <option value="popular" {% if current_filters.sort == 'popular' %}selected{% endif %}>پرفروش‌ترین</option>
                        <option value="price_low" {% if current_filters.sort == 'price_low' %}selected{% endif %}>ارزان‌ترین</option>
                        <option value="price_high" {% if current_filters.sort == 'price_high' %}selected{% endif %}>گران‌ترین</option>
                        <option value="rating" {% if current_filters.sort == 'rating' %}selected{% endif %}>بالاترین امتیاز</option>
                        <option value="discount" {% if current_filters.sort == 'discount' %}selected{% endif %}>بیشترین تخفیف</option>
                    </select>
                </form>
                <div class="view-options">
                    <button class="view-btn active" id="gridViewBtn">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="view-btn" id="listViewBtn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Products Grid -->
        <div class="products-grid" id="productsGrid">
            {% for product in products %}
            <div class="product-card fade-in">
                <div class="product-image-container">
                    <div class="product-badges">
                        {% if product.is_new %}
                        <span class="product-badge new">جدید</span>
                        {% endif %}
                        {% if product.has_discount %}
                        <span class="product-badge sale">{{ product.discount_percent }}% تخفیف</span>
                        {% endif %}
                        {% if product.is_featured %}
                        <span class="product-badge">ویژه</span>
                        {% endif %}
                    </div>
                    <div class="product-actions">
                        <button class="action-btn {% if product.is_favorited %}active{% endif %}" onclick="toggleWishlist(this, '{{ product.id }}')">
                            <i class="fa{% if product.is_favorited %}s{% else %}r{% endif %} fa-heart"></i>
                        </button>
                        <button class="action-btn" onclick="openQuickView('{{ product.id }}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" onclick="shareProduct('{{ product.id }}')">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                    <a href="{{ product.get_absolute_url }}">
                        {% with image=product.get_main_image %}
                        <img src="{% if image %}{{ image.image.url }}{% else %}{% static 'images/zima_theme/product-placeholder.jpg' %}{% endif %}"
                             alt="{{ product.name }}" class="product-image">
                        {% endwith %}
                    </a>
                </div>
                <div class="product-info">
                    <div class="product-brand">{{ product.brand }}</div>
                    <a href="{{ product.get_absolute_url }}" class="text-decoration-none">
                        <h3 class="product-name">{{ product.name }}</h3>
                    </a>
                    <div class="product-details">
                        <div class="product-rating">
                            <div class="stars">
                                {% with rating=product.get_average_rating %}
                                {% for i in "12345" %}
                                <i class="fa{% if forloop.counter <= rating %}s{% else %}r{% endif %} fa-star star"></i>
                                {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="rating-count">({{ product.get_rating_count }})</span>
                        </div>
                        <div class="product-sizes">{{ product.get_available_sizes_display }}</div>
                    </div>
                    <div class="product-colors">
                        {% for color in product.get_available_colors %}
                        <div class="color-dot" style="background: {{ color.hex_code }}; {% if color.hex_code == '#FFFFFF' %}border: 2px solid #ddd;{% endif %}" title="{{ color.name }}"></div>
                        {% endfor %}
                    </div>
                    <div class="product-price-container">
                        <div class="product-price">
                            <span class="price-current">{{ product.get_formatted_display_price }} تومان</span>
                            {% if product.has_discount %}
                            <span class="price-original">{{ product.get_formatted_price }} تومان</span>
                            {% endif %}
                        </div>
                        {% if product.has_discount %}
                        <span class="discount-percentage">{{ product.discount_percent }}%</span>
                        {% endif %}
                    </div>
                    {% if product.is_in_stock %}
                        <button class="product-add-cart" onclick="addToCart('{{ product.id }}')">
                            <i class="fas fa-shopping-cart"></i>
                            افزودن به سبد خرید
                        </button>
                    {% else %}
                        <button class="product-add-cart" disabled style="background: #ccc; cursor: not-allowed;">
                            <i class="fas fa-times"></i>
                            ناموجود
                        </button>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>محصولی یافت نشد</h3>
                <p>لطفاً فیلترهای خود را تغییر دهید یا جستجوی جدیدی انجام دهید.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if products.has_other_pages %}
        <div class="pagination">
            {% if products.has_previous %}
            <a href="?{% url_replace page=products.previous_page_number %}" class="page-btn">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="page-btn disabled">
                <i class="fas fa-chevron-right"></i>
            </span>
            {% endif %}

            {% for page_num in products.paginator.page_range %}
                {% if page_num == products.number %}
                    <span class="page-btn active">{{ page_num }}</span>
                {% else %}
                    <a href="?{% url_replace page=page_num %}" class="page-btn">{{ page_num }}</a>
                {% endif %}
            {% endfor %}
            {% if products.has_next %}
            <a href="?{% url_replace page=products.next_page_number %}" class="page-btn">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% else %}
            <span class="page-btn disabled">
                <i class="fas fa-chevron-left"></i>
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Mobile Filter Toggle -->
<button class="mobile-filter-toggle" onclick="toggleMobileFilter()">
    <i class="fas fa-filter"></i> فیلترها
</button>

<!-- Quick View Modal Structure -->
<div class="quick-view-modal" id="quickViewModal">
    <div class="modal-content-qv">
        <button class="modal-close" onclick="closeQuickView()">
            <i class="fas fa-times"></i>
        </button>
        <div id="quickViewModalContent">
            <p style="text-align: center; padding: 50px;">در حال بارگذاری...</p>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}<script>
    // Share Product function (simple placeholder)
    function shareProduct(productId) {
        // You can implement actual sharing logic here (e.g., copy to clipboard, open share dialog)
        showToast('لینک محصول کپی شد!', 'share-alt');
    }

    document.addEventListener('DOMContentLoaded', function() {

    // ✅ ✅ ✅ کد جدید برای نمایش گزینه‌های انتخاب شده در فیلترها ✅ ✅ ✅

    // تابع برای به‌روزرسانی نمایش گزینه‌های انتخاب شده
    function updateActiveFilters() {
        // برای فیلتر سایز
        document.querySelectorAll('.size-btn').forEach(btn => {
            const checkbox = btn.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // برای فیلتر برند
        document.querySelectorAll('.brand-label').forEach(btn => {
            const checkbox = btn.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // برای فیلتر رنگ
        document.querySelectorAll('.color-option').forEach(colorBtn => {
            const checkbox = colorBtn.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                colorBtn.classList.add('active');
            } else {
                colorBtn.classList.remove('active');
            }
        });

        // برای چک‌باکس‌های دسته‌بندی
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            const label = checkbox.closest('.category-label');
            if (checkbox.checked) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }

    // اعمال وضعیت فعلی فیلترها هنگام بارگذاری صفحه
    updateActiveFilters();

    // اضافه کردن event listener برای کلیک روی دکمه‌های سایز
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateActiveFilters();
            }
        });
    });

    // اضافه کردن event listener برای کلیک روی دکمه‌های برند
    document.querySelectorAll('.brand-label').forEach(btn => {
        btn.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateActiveFilters();
            }
        });
    });

    // اضافه کردن event listener برای کلیک روی دایره‌های رنگ
    document.querySelectorAll('.color-option').forEach(colorBtn => {
        colorBtn.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateActiveFilters();
            }
        });
    });

    // اضافه کردن event listener برای چک‌باکس‌های دسته‌بندی
    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateActiveFilters();
        });
    });

    // ✅ ✅ ✅ پایان کد جدید برای فیلترها ✅ ✅ ✅

    // Apply Filters button handles search input and general submit
    document.querySelector('.btn-apply').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('filterForm').submit();
    });

    // View Toggle Functionality (Grid vs List)
    const productsGrid = document.getElementById('productsGrid');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');

    function setView(viewType) {
        if (viewType === 'list') {
            productsGrid.style.gridTemplateColumns = '1fr';
            productsGrid.querySelectorAll('.product-card').forEach(card => {
                card.style.display = 'flex';
                card.style.flexDirection = 'row';
                card.style.height = '200px';
                card.querySelector('.product-image-container').style.minWidth = '200px';
                card.querySelector('.product-image-container').style.height = '100%';
                card.querySelector('.product-image-container').style.flexShrink = '0';
                card.querySelector('.product-info').style.flex = '1';
                const productDetails = card.querySelector('.product-details');
                const productColors = card.querySelector('.product-colors');
                if (productDetails) productDetails.style.display = 'none';
                if (productColors) productColors.style.display = 'none';
            });
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
        } else {
            productsGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            productsGrid.querySelectorAll('.product-card').forEach(card => {
                card.style.display = 'block';
                card.style.flexDirection = 'column';
                card.style.height = 'auto';
                card.querySelector('.product-image-container').style.minWidth = 'auto';
                card.querySelector('.product-image-container').style.height = '380px';
                card.querySelector('.product-image-container').style.flexShrink = 'initial';
                card.querySelector('.product-info').style.flex = 'initial';
                const productDetails = card.querySelector('.product-details');
                const productColors = card.querySelector('.product-colors');
                if (productDetails) productDetails.style.display = 'flex';
                if (productColors) productColors.style.display = 'flex';
            });
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
        }
        localStorage.setItem('productView', viewType);
    }

    // Load saved view preference
    const savedView = localStorage.getItem('productView');
    if (savedView) {
        setView(savedView);
    } else {
        setView('grid');
    }

    gridViewBtn.addEventListener('click', () => setView('grid'));
    listViewBtn.addEventListener('click', () => setView('list'));
});
</script>

{% endblock %}