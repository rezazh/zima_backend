<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}فروشگاه زیما{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* استایل برای آیکون سبد خرید */
        .cart-icon {
            position: relative;
            display: inline-block;
            margin-right: 15px;
            color: white;
            font-size: 1.2rem;
            text-decoration: none;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-icon:hover {
            color: #f8f9fa;
        }

        /* استایل برای دکمه چت */
        .floating-chat-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .floating-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,123,255,0.4);
        }

        /* استایل برای نشانگر تعداد پیام‌های خوانده نشده روی دکمه چت */
        .floating-chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .notification-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }

        /* استایل برای اعلان‌ها */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 300px;
        }

        .notification {
            background-color: white;
            border-right: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: bold;
            color: #333;
        }

        .notification-close {
            cursor: pointer;
            color: #999;
        }

        .notification-message {
            color: #666;
        }

        .notification-action {
            margin-top: 10px;
            text-align: left;
        }

        .notification-action a {
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* استایل برای اعلان‌های چت */
        .chat-notification {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 1000;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .chat-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-notification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .chat-notification-body {
            margin-bottom: 10px;
            color: #555;
        }

        .chat-notification-footer {
            text-align: right;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .view-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-btn:hover {
            background-color: #0056b3;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <header class="bg-dark text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h1 class="h4 mb-0"><a href="/" class="text-white text-decoration-none">فروشگاه زیما</a></h1>
                </div>
                <div class="col-md-6">
                    <form class="d-flex" action="{% url 'products:search' %}" method="GET">
                    <input class="form-control me-2" type="search" name="q" placeholder="جستجو..." aria-label="Search" value="{{ request.GET.q|default:'' }}">
                    <button class="btn btn-outline-light" type="submit">جستجو</button>
                    </form>
                </div>
                <div class="col-md-3 text-end d-flex align-items-center justify-content-end">
                    <!-- آیکون سبد خرید -->
                    <a href="{% url 'cart:summary' %}" class="cart-icon me-3">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="cart-items-count">
                            {% if user.is_authenticated %}
                                {{ user.cart_items.count }}
                            {% else %}
                                0
                            {% endif %}
                        </span>
                    </a>

                    <!-- آیکون نوتیفیکیشن -->
                    {% if user.is_authenticated %}
                    <a href="{% url 'chat:notifications' %}" class="cart-icon me-3">
                        <i class="fas fa-bell"></i>
                        <span class="cart-count" id="notification-count" style="display: none;">0</span>
                    </a>
                    {% endif %}

                    {% if user.is_authenticated %}
                        <div class="dropdown">
                            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                {{ user.username }}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="{% url 'users:profile' %}">پروفایل</a></li>
                                <li><a class="dropdown-item" href="#">سفارشات من</a></li>
                                <li><a class="dropdown-item" href="{% url 'chat:chat_list' %}">
                                    <i class="fas fa-comments"></i> چت‌های من
                                    <span class="badge bg-danger notification-badge" id="chat-notification-badge" style="display: none;">0</span>
                                </a></li>
                                {% if user.is_staff %}
                                    <li><a class="dropdown-item" href="{% url 'admin:index' %}">پنل مدیریت</a></li>
                                    <li><a class="dropdown-item" href="{% url 'chat:admin_dashboard' %}">داشبورد چت</a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'users:logout' %}">خروج</a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a href="{% url 'users:login' %}" class="btn btn-outline-light me-2">ورود</a>
                        <a href="{% url 'users:signup' %}" class="btn btn-light">ثبت‌نام</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="container my-4">
        {% load i18n %}
        {% if messages %}
        <div class="django-messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>فروشگاه زیما</h5>
                    <p>فروشگاه آنلاین محصولات با کیفیت</p>
                </div>
                <div class="col-md-4">
                    <h5>لینک‌های مفید</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white">درباره ما</a></li>
                        <li><a href="#" class="text-white">تماس با ما</a></li>
                        <li><a href="#" class="text-white">قوانین و مقررات</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>تماس با ما</h5>
                    <address>
                        <p>آدرس: تهران، خیابان ولیعصر</p>
                        <p>تلفن: 021-12345678</p>
                        <p>ایمیل: info@zima.com</p>
                    </address>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 1404 فروشگاه زیما. تمامی حقوق محفوظ است.</p>
            </div>
        </div>
    </footer>

    <!-- دکمه چت پشتیبانی - تغییر مسیر بر اساس نوع کاربر -->
    {% if user.is_authenticated %}
    <div class="floating-chat-btn" id="floating-chat-btn" title="{% if user.is_staff %}داشبورد چت{% else %}چت‌های من{% endif %}">
        <i class="fas {% if user.is_staff %}fa-headset{% else %}fa-comments{% endif %} fa-lg"></i>
        <span class="floating-chat-badge" id="unread-count" style="display: none;">0</span>
    </div>

    <!-- کانتینر اعلان‌ها -->
    <div id="notification-container" class="notification-container"></div>

    <!-- صدای اعلان -->
    <audio id="notification-sound" preload="auto" style="display: none;">
        <source src="{% static 'sounds/notification.mp3' %}" type="audio/mpeg">
    </audio>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    {% if user.is_authenticated %}
    <script>
        // تنظیم متغیر برای تشخیص اینکه کاربر احراز هویت شده است
        const userIsAuthenticated = true;

        // سوکت اعلان و سوکت وضعیت آنلاین
        let notificationSocket = null;
        let onlineStatusSocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // تابع اتصال به سوکت اعلان‌ها
        function connectNotificationSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/notifications/`;

            notificationSocket = new WebSocket(wsUrl);

            notificationSocket.onopen = function(e) {
                console.log('Notification socket connected');
                reconnectAttempts = 0; // بازنشانی تعداد تلاش‌ها پس از اتصال موفق
                // شروع ارسال منظم سیگنال heartbeat
                startHeartbeat();
            };

            notificationSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);

                if (data.type === 'unread_count') {
                    handleUnreadCountUpdate(data.count);
                } else if (data.type === 'chat_notification') {
                    handleChatNotification(data);
                } else if (data.type === 'user_status_update') {
                    updateUserStatus(data.user_id, data.status);
                } else if (data.type === 'heartbeat_response') {
                    // سرور پاسخ heartbeat را دریافت کرده است
                    console.log('Heartbeat acknowledged by server');
                }
            };

            notificationSocket.onclose = function(e) {
                console.log('Notification socket closed');

                // تلاش مجدد برای اتصال با فاصله زمانی بیشتر در هر بار تلاش
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    reconnectAttempts++;

                    console.log(`Reconnecting in ${delay/1000} seconds... (Attempt ${reconnectAttempts})`);

                    setTimeout(function() {
                        connectNotificationSocket();
                    }, delay);
                } else {
                    console.log('Maximum reconnection attempts reached. Using fallback HTTP method.');
                    // استفاده از روش HTTP به عنوان پشتیبان
                    startHttpFallback();
                }
            };

            notificationSocket.onerror = function(e) {
                console.error('Notification socket error:', e);
            };
        }

        // تابع اتصال به سوکت وضعیت آنلاین
        function connectOnlineStatusSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/online-status/`;

            onlineStatusSocket = new WebSocket(wsUrl);

            onlineStatusSocket.onopen = function(e) {
                console.log('Online status socket connected');

                // ارسال heartbeat هر 30 ثانیه
                setInterval(function() {
                    if (onlineStatusSocket.readyState === WebSocket.OPEN) {
                        onlineStatusSocket.send(JSON.stringify({
                            'type': 'heartbeat'
                        }));
                    }
                }, 30000);
            };

            onlineStatusSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Online status message received:', data);

                // پردازش پیام‌های دریافتی
                if (data.type === 'status_update') {
                    updateUserStatus(data.user_id, data.status);
                }
            };

            onlineStatusSocket.onclose = function(e) {
                console.log('Online status socket closed');

                // تلاش مجدد برای اتصال
                setTimeout(function() {
                    connectOnlineStatusSocket();
                }, 5000);
            };

            onlineStatusSocket.onerror = function(e) {
                console.error('Online status socket error:', e);
            };

            // تنظیم وضعیت آفلاین هنگام بستن صفحه یا رفرش
            window.addEventListener('beforeunload', function() {
                if (onlineStatusSocket.readyState === WebSocket.OPEN) {
                    // ارسال پیام آفلاین شدن
                    onlineStatusSocket.send(JSON.stringify({
                        'type': 'offline'
                    }));
                }
            });
        }

        // ارسال سیگنال heartbeat هر 30 ثانیه
        let heartbeatInterval = null;
        function startHeartbeat() {
            // توقف هر heartbeat قبلی
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }

            // شروع ارسال heartbeat جدید
            heartbeatInterval = setInterval(function() {
                if (notificationSocket && notificationSocket.readyState === WebSocket.OPEN) {
                    notificationSocket.send(JSON.stringify({
                        'type': 'heartbeat'
                    }));
                }
            }, 30000); // هر 30 ثانیه
        }

        // در صورت عدم موفقیت در اتصال WebSocket، از HTTP استفاده کنیم
        function startHttpFallback() {
            // توقف هر تایمر قبلی
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            // ارسال وضعیت آنلاین با HTTP
            fetch('/chat/set-online/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            }).catch(error => console.error('Error updating online status:', error));

            // تنظیم تایمر جدید با HTTP
            heartbeatInterval = setInterval(function() {
                fetch('/chat/set-online/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                }).catch(error => console.error('Error updating online status:', error));

                // همچنین بررسی پیام‌های خوانده نشده
                checkUnreadCounts();
            }, 60000); // هر 60 ثانیه
        }

        // پردازش بروزرسانی تعداد پیام‌های خوانده نشده
        function handleUnreadCountUpdate(count) {
            // بروزرسانی نشانگر روی دکمه شناور چت
            const unreadBadge = document.getElementById('unread-count');
            if (unreadBadge) {
                if (count > 0) {
                    unreadBadge.textContent = count;
                    unreadBadge.style.display = 'flex';
                } else {
                    unreadBadge.style.display = 'none';
                }
            }

            // بروزرسانی نشانگر در منوی کاربر
            const chatNotificationBadge = document.getElementById('chat-notification-badge');
            if (chatNotificationBadge) {
                if (count > 0) {
                    chatNotificationBadge.textContent = count;
                    chatNotificationBadge.style.display = 'inline-block';
                } else {
                    chatNotificationBadge.style.display = 'none';
                }
            }
        }

        // پردازش اعلان چت جدید
        function handleChatNotification(data) {
            // نمایش اعلان به کاربر
            if (Notification.permission === "granted") {
                const notification = new Notification(data.is_admin ? "پیام جدید از پشتیبانی" : `پیام جدید از ${data.sender}`, {
                    body: data.message,
                    icon: '/static/img/logo-small.png'
                });

                notification.onclick = function() {
                    window.focus();
                    window.location.href = `/chat/room/${data.room_id}/`;
                };
            }

            // پخش صدای اعلان
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.play().catch(e => console.log('Error playing notification sound:', e));
            }

            // نمایش اعلان در صفحه
            showChatNotification(data.message, data.sender, data.room_id);
        }

        // نمایش اعلان چت در صفحه
        function showChatNotification(message, sender, roomId) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'chat-notification';
            notificationDiv.innerHTML = `
                <div class="chat-notification-header">
                    <strong>پیام جدید از ${sender}</strong>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="chat-notification-body">${message}</div>
                <div class="chat-notification-footer">
                    <button class="view-btn">مشاهده</button>
                </div>
            `;

            document.body.appendChild(notificationDiv);

            // نمایش اعلان با انیمیشن
            setTimeout(() => {
                notificationDiv.classList.add('show');
            }, 100);

            // دکمه بستن اعلان
            notificationDiv.querySelector('.close-btn').addEventListener('click', function() {
                notificationDiv.classList.remove('show');
                setTimeout(() => {
                    notificationDiv.remove();
                }, 300);
            });

            // دکمه مشاهده چت
            notificationDiv.querySelector('.view-btn').addEventListener('click', function() {
                window.location.href = `/chat/room/${roomId}/`;
            });

            // حذف خودکار اعلان بعد از 10 ثانیه
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.classList.remove('show');
                    setTimeout(() => {
                        if (notificationDiv.parentNode) {
                            notificationDiv.remove();
                        }
                    }, 300);
                }
            }, 10000);
        }

        // بروزرسانی وضعیت کاربر
        function updateUserStatus(userId, status) {
            // پیدا کردن تمام المان‌های نشان‌دهنده وضعیت کاربر با این شناسه
            const statusIndicators = document.querySelectorAll(`.user-status-indicator[data-user-id="${userId}"]`);

            statusIndicators.forEach(indicator => {
                // حذف کلاس‌های قبلی
                indicator.classList.remove('online', 'offline');

                // اضافه کردن کلاس جدید بر اساس وضعیت
                indicator.classList.add(status);

                // بروزرسانی متن نمایش داده شده (اگر وجود دارد)
                const statusText = indicator.querySelector('.status-text');
                if (statusText) {
                    statusText.textContent = status === 'online' ? 'آنلاین' : 'آفلاین';
                }
            });
        }

        // محدودسازی تعداد درخواست‌ها
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ارسال heartbeat محدودشده بر اساس فعالیت کاربر
        const throttledHeartbeat = throttle(function() {
            if (notificationSocket && notificationSocket.readyState === WebSocket.OPEN) {
                notificationSocket.send(JSON.stringify({
                    'type': 'heartbeat'
                }));
            }

            if (onlineStatusSocket && onlineStatusSocket.readyState === WebSocket.OPEN) {
                onlineStatusSocket.send(JSON.stringify({
                    'type': 'heartbeat'
                }));
            }
        }, 5000); // حداکثر هر 5 ثانیه یک بار بر اساس فعالیت کاربر

        // رویدادهای فعالیت کاربر - فقط heartbeat محدودشده را فعال می‌کنند
        ['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, throttledHeartbeat);
        });

        // برای mousemove، محدودیت بیشتری اعمال می‌کنیم چون خیلی زیاد فراخوانی می‌شود
        document.addEventListener('mousemove', throttle(function() {
            throttledHeartbeat();
        }, 10000)); // حداکثر هر 10 ثانیه یک بار برای حرکت موس

        // تغییر وضعیت به آفلاین هنگام بستن صفحه
        window.addEventListener('beforeunload', function() {
            // ارسال درخواست برای تغییر وضعیت به آفلاین
            if (notificationSocket && notificationSocket.readyState === WebSocket.OPEN) {
                // ارسال پیام آفلاین شدن از طریق WebSocket
                notificationSocket.send(JSON.stringify({
                    'type': 'offline'
                }));
            }

            if (onlineStatusSocket && onlineStatusSocket.readyState === WebSocket.OPEN) {
                // ارسال پیام آفلاین شدن از طریق WebSocket وضعیت آنلاین
                onlineStatusSocket.send(JSON.stringify({
                    'type': 'offline'
                }));
            } else {
                // استفاده از HTTP fallback
                navigator.sendBeacon('/chat/set-offline/', '');
            }
        });

        // بررسی پیام‌های خوانده نشده با HTTP
        function checkUnreadCounts() {
            fetch('/chat/unread-count/')
                .then(response => response.json())
                .then(data => {
                    handleUnreadCountUpdate(data.count);
                })
                .catch(error => console.error('Error fetching unread count:', error));
        }

        // مجوز برای اعلان‌ها
        function requestNotificationPermission() {
            if (Notification && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // دریافت توکن CSRF از کوکی‌ها
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // اجرای توابع در زمان بارگذاری صفحه
        document.addEventListener('DOMContentLoaded', function() {
            // بررسی اولیه پیام‌های خوانده نشده
            checkUnreadCounts();

            // درخواست دسترسی به اعلان‌ها
            requestNotificationPermission();

            // اتصال به WebSocket اعلان‌ها
            try {
                connectNotificationSocket();
            } catch (e) {
                console.error("Error connecting to notification socket:", e);
                // در صورت خطا در اتصال به WebSocket، از روش HTTP استفاده می‌کنیم
                startHttpFallback();
            }

            // اتصال به WebSocket وضعیت آنلاین
            try {
                connectOnlineStatusSocket();
            } catch (e) {
                console.error("Error connecting to online status socket:", e);
            }

            // تنظیم عملکرد دکمه چت شناور بر اساس نوع کاربر
            const chatBtn = document.getElementById('floating-chat-btn');
            if (chatBtn) {
                chatBtn.addEventListener('click', function() {
                    {% if user.is_staff %}
                        // هدایت ادمین به داشبورد چت
                        window.location.href = "{% url 'chat:admin_dashboard' %}";
                    {% else %}
                        // هدایت کاربر عادی به لیست چت‌ها
                        window.location.href = "{% url 'chat:chat_list' %}";
                    {% endif %}
                });
            }
        });
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>
</html>