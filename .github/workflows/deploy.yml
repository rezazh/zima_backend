name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        command_timeout: 15m
        script: |
          #!/bin/bash
          set -e
          
          echo "===== Starting deployment at $(date) ====="
          
          # مرحله 1: آماده‌سازی
          echo "===== Stage 1: Preparing ====="
          cd /var/www/zimabestshop/zima_backend
          git reset --hard
          git clean -fd
          
          # مرحله 2: دریافت تغییرات
          echo "===== Stage 2: Pulling changes ====="
          git pull origin main
          
          # مرحله 3: توقف کانتینرها
          echo "===== Stage 3: Stopping containers ====="
          docker-compose down --timeout 60 || echo "Stop failed, continuing..."
          
          # مرحله 4: راه‌اندازی مجدد
          echo "===== Stage 4: Starting containers ====="
          docker-compose up -d --build
          
          # مرحله 5: بررسی وضعیت
          echo "===== Stage 5: Health check ====="
          sleep 15
          docker-compose ps
          
          echo "===== Deployment completed at $(date) ====="