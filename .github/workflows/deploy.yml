name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30m
          debug: true
          script: |
            #!/bin/bash
            # Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ
            set +e
            
            echo "===== Starting deployment at $(date) ====="
            
            # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
            echo "===== Stage 1: Preparing ====="
            cd /var/www/zimabestshop/zima_backend || { echo "âŒ Failed to access project directory"; exit 1; }
            
            # Ø°Ø®ÛŒØ±Ù‡ Ù‡Ø´ Ú©Ø§Ù…ÛŒØª ÙØ¹Ù„ÛŒ
            OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
            
            git reset --hard
            git clean -fd
            
            # Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª
            echo "===== Stage 2: Pulling changes ====="
            git pull origin main
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
            NEW_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
            if [ "$OLD_COMMIT" != "$NEW_COMMIT" ]; then
              echo "âœ… Changes detected - will rebuild containers"
              NEEDS_REBUILD=true
            else
              echo "â„¹ï¸ No changes detected - will restart containers"
              NEEDS_REBUILD=false
            fi
            
            # Ù…Ø±Ø­Ù„Ù‡ 3: Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            echo "===== Stage 3: Database backup ====="
            BACKUP_DIR="/var/www/zimabestshop/backups"
            mkdir -p $BACKUP_DIR
            BACKUP_FILE="$BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql"
            
            # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            DB_CONTAINER=$(docker-compose ps -q postgres 2>/dev/null || docker ps -qf name=zima_postgres 2>/dev/null || echo "")
            
            if [ -n "$DB_CONTAINER" ] && docker inspect $DB_CONTAINER &>/dev/null; then
              echo "Creating database backup..."
              docker exec $DB_CONTAINER pg_dumpall -U postgres > $BACKUP_FILE 2>/dev/null && echo "âœ… Backup saved to $BACKUP_FILE" || echo "âš ï¸ Database backup failed, continuing"
            else
              echo "â„¹ï¸ Database container not running, skipping backup"
            fi
            
            # Ù…Ø±Ø­Ù„Ù‡ 4: ØªÙˆÙ‚Ù Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§
            echo "===== Stage 4: Stopping containers ====="
            docker-compose down --timeout 60 || echo "âš ï¸ Stop failed, continuing..."
            
            # Ù…Ø±Ø­Ù„Ù‡ 5: Ø¨Ø±Ø±Ø³ÛŒ ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú© Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
            echo "===== Stage 5: Checking disk space ====="
            DISK_SPACE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//' || echo "0")
            if [ "$DISK_SPACE" -gt 80 ]; then
              echo "âš ï¸ Disk space is low ($DISK_SPACE%), cleaning up old images..."
              docker image prune -af --filter "until=24h" || echo "âš ï¸ Cleanup failed, continuing"
            else
              echo "âœ… Disk space is sufficient ($DISK_SPACE%)"
            fi
            
            # Ù…Ø±Ø­Ù„Ù‡ 6: Ø¨ÛŒÙ„Ø¯ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§
            echo "===== Stage 6: Building and starting containers ====="
            
            # Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ± Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø§ Ù…Ú©Ø§Ù†ÛŒØ²Ù… ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
            echo "Pre-pulling essential images..."
            for IMG in "nginx:alpine" "redis:latest" "postgres:15-alpine" "python:3.11-alpine"; do
              if ! docker image inspect "$IMG" &>/dev/null; then
                echo "Pulling $IMG..."
                for TRY in {1..3}; do
                  docker pull "$IMG" && break || echo "âš ï¸ Pull attempt $TRY failed"
                  [ $TRY -eq 3 ] && echo "âš ï¸ Could not pull $IMG, will use cached version if available"
                  sleep 3
                done
              fi
            done
            
            # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§ Ø¨Ø§ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ù†Ø§Ø³Ø¨
            if [ "$NEEDS_REBUILD" = true ]; then
              echo "Performing full rebuild..."
              for TRY in {1..3}; do
                echo "Attempt $TRY to build and start containers..."
                if docker-compose up -d --build; then
                  echo "âœ… Containers built and started successfully"
                  break
                else
                  echo "âš ï¸ Build attempt $TRY failed"
                  [ $TRY -eq 3 ] && echo "âš ï¸ All build attempts failed, continuing anyway"
                  sleep 5
                fi
              done
            else
              echo "Starting containers without rebuild..."
              for TRY in {1..3}; do
                echo "Attempt $TRY to start containers..."
                if docker-compose up -d; then
                  echo "âœ… Containers started successfully"
                  break
                else
                  echo "âš ï¸ Start attempt $TRY failed"
                  [ $TRY -eq 3 ] && echo "âš ï¸ All start attempts failed, continuing anyway"
                  sleep 5
                fi
              done
            fi
            
            # Ù…Ø±Ø­Ù„Ù‡ 7: Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø§ÛŒÚ¯Ø±ÛŒØ´Ù†â€ŒÙ‡Ø§
            echo "===== Stage 7: Running migrations ====="
            echo "Waiting for database to be ready..."
            for i in {1..15}; do
              if docker-compose exec -T postgres pg_isready -U postgres &>/dev/null; then
                echo "âœ… Database is ready"
                break
              fi
              echo "Waiting for database... ($i/15)"
              [ $i -eq 15 ] && echo "âš ï¸ Database not ready, but continuing"
              sleep 2
            done
            
            # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¬Ù†Ú¯Ùˆ
            DJANGO_CONTAINER=""
            for SERVICE in web django app gunicorn; do
              CONTAINER_ID=$(docker-compose ps -q $SERVICE 2>/dev/null || echo "")
              if [ -n "$CONTAINER_ID" ]; then
                DJANGO_CONTAINER=$CONTAINER_ID
                echo "âœ… Found Django container: $SERVICE"
                break
              fi
            done
            
            if [ -n "$DJANGO_CONTAINER" ]; then
              echo "Running migrations..."
              docker exec $DJANGO_CONTAINER python manage.py migrate --noinput && echo "âœ… Migrations completed" || echo "âš ï¸ Migration failed"
              
              echo "Collecting static files..."
              docker exec $DJANGO_CONTAINER python manage.py collectstatic --noinput && echo "âœ… Static files collected" || echo "âš ï¸ Static collection failed"
            else
              echo "âš ï¸ Django container not found, skipping migrations"
            fi
            
            # Ù…Ø±Ø­Ù„Ù‡ 8: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ù„Ø§Ù…Øª
            echo "===== Stage 8: Health check ====="
            echo "Waiting for services to stabilize..."
            sleep 10
            
            echo "Current containers:"
            docker-compose ps || docker ps
            
            # Ù…Ø±Ø­Ù„Ù‡ 9: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
            echo "===== Stage 9: Cleanup ====="
            if [ -n "$DJANGO_CONTAINER" ]; then
              echo "Cleaning up cache files..."
              docker exec $DJANGO_CONTAINER sh -c "find /tmp -type f -name '*.py[co]' -delete 2>/dev/null; find /tmp -type d -name '__pycache__' -delete 2>/dev/null" || echo "âš ï¸ Cache cleanup failed"
            fi
            
            # Ø­Ø°Ù Ø¨Ú©Ø§Ù¾â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
            echo "Removing backups older than 7 days..."
            find $BACKUP_DIR -name "db_backup_*.sql" -type f -mtime +7 -delete 2>/dev/null || echo "âš ï¸ Old backup cleanup failed"
            
            # Ù…Ø±Ø­Ù„Ù‡ 10: Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
            echo "===== Stage 10: Recent logs ====="
            docker-compose logs --tail=20 || echo "âš ï¸ Could not fetch logs"
            
            echo "===== Deployment completed successfully at $(date) ====="
            
            # Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡ ØªØºÛŒÛŒØ±Ø§Øª
            if [ "$OLD_COMMIT" != "$NEW_COMMIT" ] && [ "$OLD_COMMIT" != "unknown" ]; then
              COMMIT_COUNT=$(git log --oneline $OLD_COMMIT..$NEW_COMMIT | wc -l || echo "?")
              echo "ğŸ“Š Summary: Deployed $COMMIT_COUNT new commit(s)"
              echo "ğŸ”„ From: $OLD_COMMIT"
              echo "ğŸ”„ To: $NEW_COMMIT"
            else
              echo "ğŸ“Š Summary: No new changes were deployed"
            fi
            
            exit 0