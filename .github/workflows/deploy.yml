name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            #!/bin/bash
            set -e  # Ø®Ø±ÙˆØ¬ Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§
            trap 'echo "âŒ Error occurred at line $LINENO. Command: $BASH_COMMAND"' ERR
            
            echo "ðŸš€ Starting deployment: $(date)"
            
            # 1. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª
            cd /var/www/zimabestshop/zima_backend
            OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
            git fetch origin main
            git reset --hard origin/main
            NEW_COMMIT=$(git rev-parse HEAD)
            
            # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
            if [ "$OLD_COMMIT" = "$NEW_COMMIT" ]; then
              echo "âœ… No changes detected. Deployment not needed."
              exit 0
            fi
            
            echo "ðŸ“¦ Changes detected. Deploying commit: ${NEW_COMMIT:0:8}"
            
            # 2. Ø¨Ú©Ø§Ù¾ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (ÙÙ‚Ø· Ø§Ú¯Ø± ØªØºÛŒÛŒØ±Ø§Øª Ù…Ø¯Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
            if git diff --name-only $OLD_COMMIT $NEW_COMMIT | grep -q "models.py\|migrations/"; then
              echo "ðŸ”„ Model changes detected. Creating database backup..."
              BACKUP_DIR="/var/www/zimabestshop/backups"
              mkdir -p $BACKUP_DIR
              BACKUP_FILE="$BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql"
              docker-compose exec -T postgres pg_dumpall -U postgres > $BACKUP_FILE || echo "âš ï¸ Backup failed but continuing"
            fi
            
            # 3. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§
            echo "ðŸ”„ Restarting containers..."
            docker-compose down
            docker-compose up -d --build
            
            # 4. Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            echo "â³ Waiting for database..."
            for i in {1..10}; do
              if docker-compose exec -T postgres pg_isready -U postgres &>/dev/null; then
                echo "âœ… Database is ready"
                break
              fi
              echo "â³ Waiting... ($i/10)"
              sleep 3
            done
            
            # 5. Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø§ÛŒÚ¯Ø±ÛŒØ´Ù†â€ŒÙ‡Ø§
            echo "ðŸ”„ Running migrations..."
            docker-compose exec -T django python manage.py migrate --noinput
            docker-compose exec -T django python manage.py collectstatic --noinput
            
            # 6. Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
            echo "ðŸ§¹ Cleaning up..."
            docker image prune -f
            find $BACKUP_DIR -name "db_backup_*.sql" -type f -mtime +7 -delete 2>/dev/null || true
            
            # 7. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
            echo "âœ… Deployment completed: $(date)"
            echo "ðŸ“Š Summary: Deployed changes from ${OLD_COMMIT:0:8} to ${NEW_COMMIT:0:8}"
            docker-compose ps