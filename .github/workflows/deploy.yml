name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Prepare server
      run: |
        ssh -T -o StrictHostKeyChecking=no -o ConnectTimeout=120 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "===== Starting deployment process ====="
          
          # بررسی وجود دایرکتوری پروژه
          if [ -d "/var/www/zimabestshop/zima_backend" ]; then
            cd /var/www/zimabestshop/zima_backend
            echo "Resetting any local changes..."
            git reset --hard
            git clean -fd
          else
            echo "Directory not found, creating..."
            mkdir -p /var/www/zimabestshop
            cd /var/www/zimabestshop
            git clone https://github.com/rezazh/zima_backend.git
            cd zima_backend
          fi
          
          # دریافت آخرین تغییرات از گیت
          echo "Pulling latest changes from git..."
          git pull --ff-only origin main || (echo "Fast-forward pull failed, fetching and resetting..." && git fetch origin main && git reset --hard origin/main)
          
          # نمایش تغییرات دریافت شده
          echo "Recent commits:"
          git log -1 --pretty=format:"%h - %an, %ar : %s"
          
          # توقف کانتینرهای موجود با حفظ داده‌ها
          echo "Stopping containers..."
          docker-compose down || echo "Docker-compose down failed"
          
          echo "Preparation completed"
        EOF

  deploy:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy application
      run: |
        ssh -T -o StrictHostKeyChecking=no -o ConnectTimeout=120 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /var/www/zimabestshop/zima_backend
          
          # شناسایی سرویس‌های تغییر یافته برای بیلد انتخابی
          echo "Building containers..."
          DOCKER_BUILDKIT=1 docker-compose build --progress=plain
          
          # راه‌اندازی کانتینرها در پس‌زمینه
          echo "Starting containers..."
          docker-compose up -d
          
          echo "Deployment completed"
        EOF

  finalize:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Run migrations and check status
      run: |
        ssh -T -o StrictHostKeyChecking=no -o ConnectTimeout=120 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /var/www/zimabestshop/zima_backend
          
          # اجرای مایگریشن‌ها
          echo "Running migrations..."
          docker-compose exec -T gunicorn python manage.py migrate chat || true
          docker-compose exec -T gunicorn python manage.py migrate --fake-initial || true
          
          # بررسی وضعیت کانتینرها
          echo "Container status:"
          docker-compose ps
          
          # نمایش لاگ‌های خطا (اگر وجود داشته باشد)
          echo "Checking for errors in logs..."
          docker-compose logs --tail=10 | grep -i "error\|warn\|fail" || echo "No immediate errors found"
          
          echo "===== Deployment completed ====="
        EOF